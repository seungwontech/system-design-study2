# 3장: 구글 맵 서비스 설계

**설계의 트레이드오프, 면접 질문, 심화 토론**을 위주로 진행하기 위한 정리 자료입니다.

---

## 🗺️ 핵심 설계 포인트

### 1. 지도 데이터의 효율적 관리 (Tiling & Geohashing)
* **문제**: 전 세계 지도는 수백 PB에 달하는 거대한 이미지 데이터입니다. 이를 통째로 로딩하는 것은 불가능합니다.
* **해결책**:
    * **타일링(Tiling)**: 지도를 작은 격자(Tile)로 쪼개어, 사용자가 보고 있는 영역의 타일만 다운로드합니다.
    * **확대 수준(Zoom Level)**: 줌 레벨에 따라 다른 해상도의 타일을 준비하여(Level of Detail), 확대할수록 더 상세한 정보를 보여줍니다.
    * **지오해싱(Geohashing)**: 2차원 좌표를 1차원 문자열로 변환하여, 타일의 인덱싱과 검색 속도를 높입니다.

### 2. 경로 탐색 최적화 (Routing Tiles)
* **문제**: 전 세계 도로망 데이터를 메모리에 올려서 다익스트라 알고리즘을 돌리는 것은 불가능합니다.
* **해결책**:
    * **경로 안내 타일(Routing Tile)**: 도로망 데이터도 지도 타일처럼 작은 단위로 쪼개어 파일(S3)로 저장합니다.
    * **계층적 구조**: 상(지방도), 중(간선도로), 하(고속도로)로 데이터를 계층화하여, 장거리 경로 탐색 시에는 '하' 레벨 타일만 사용하여 탐색 범위를 줄입니다.

### 3. 실시간 위치 갱신과 DB 선택
* **문제**: 수억 명의 사용자가 보내는 위치 정보(Write)를 실시간으로 처리해야 합니다.
* **해결책**:
    * **Cassandra**: 쓰기 성능이 뛰어나고 수평 확장이 용이한 NoSQL DB를 사용하여 위치 이력을 저장합니다.
    * **Kafka**: 위치 데이터를 스트림으로 받아 실시간 교통 상황 분석, 경로 재탐색 등 여러 서비스로 전파합니다.

### 4. 적응형 ETA와 경로 재설정 (Adaptive ETA)
* **문제**: 내가 가는 길에 갑자기 사고가 났을 때, 어떻게 영향을 받는 사용자만 골라내어 알림을 줄 수 있을까요?
* **해결책**:
    * **재귀적 타일 관리**: 사용자가 지나가는 경로의 타일뿐만 아니라, 그 상위(Super) 타일들도 함께 인덱싱합니다.
    * 사고가 발생한 타일이 포함된 상위 타일을 구독하는 사용자들을 빠르게 찾아내어(O(n)), 경로 재설정 알림을 보냅니다.

---

## 1. 핵심 트레이드오프 및 설계 논의 (Trade-offs)
설계 선택지 사이의 장단점을 비교하고, 상황에 맞는 최적의 선택을 논의합니다.

### 1.1. 지도 타일 렌더링: 서버 사이드(Raster) vs 클라이언트 사이드(Vector)
| 특성 | **서버 사이드 (Raster Tiles)** | **클라이언트 사이드 (Vector Tiles)** |
| :--- | :--- | :--- |
| **데이터 형식** | 미리 생성된 이미지 (PNG/JPG) | 수학적 데이터 (점, 선, 면, 좌표) |
| **네트워크 대역폭** | **높음** (이미지 파일 전송) | **낮음** (압축률이 매우 높음) |
| **확대/축소 품질** | 깨지거나 흐릿해짐 (픽셀화) | **매우 매끄러움** (해상도 무관) |
| **클라이언트 부하** | 낮음 (이미지만 표시하면 됨) | **높음** (실시간 렌더링 연산 필요) |
| **스타일 변경** | 서버에서 다시 생성해야 함 | 클라이언트에서 즉시 변경 가능 (다크 모드 등) |

> **논의 포인트**: 
> * "저사양 기기가 많은 개발도상국 타겟 서비스라면?" (Raster가 유리할 수 있음)
> * "데이터 요금에 민감한 사용자라면?" (Vector가 유리함)

### 1.2. 경로 탐색 데이터 관리: 인접 리스트(메모리) vs 그래프 DB vs 타일 기반 파일
| 방식 | **인접 리스트 (In-Memory)** | **그래프 DB (Neo4j 등)** | **타일 기반 파일 (S3 + Cache)** |
| :--- | :--- | :--- | :--- |
| **탐색 속도** | **가장 빠름** | 보통 (네트워크/디스크 I/O 발생) | 빠름 (필요한 부분만 로딩) |
| **메모리 사용량** | **매우 높음** (전 세계 도로망 불가) | 낮음 | 낮음 (필요한 타일만 로딩) |
| **비용** | 매우 비쌈 (고용량 RAM 서버 필요) | 비쌈 (라이선스 및 운영 비용) | **저렴** (S3 스토리지 비용) |
| **적합성** | 소규모 지역 서비스 | 복잡한 관계 질의가 필요한 경우 | **구글 맵 같은 대규모 서비스** |

> **논의 포인트**: 
> * "전 세계 도로망 데이터를 메모리에 다 올릴 수 없다면?" (책에서 제안한 **경로 안내 타일** 방식이 현실적)

---

## 2. 면접 예상 질문 (Interview Q&A)
면접관이 꼬리를 물고 들어올 수 있는 질문들과 모범 답변 키워드입니다.

### Q1. "사용자가 경로를 이탈했을 때(Rerouting) 서버는 어떻게 감지하고 처리하나요?"
* **핵심 키워드**: `클라이언트 감지`, `임계값(Threshold)`, `새로운 경로 요청`
* **답변 논리**:
    * 서버가 매번 감시하는 것은 비효율적입니다.
    * **클라이언트**가 현재 위치와 안내 경로 사이의 거리를 주기적으로 계산합니다.
    * 거리가 특정 **임계값(예: 20m)**을 벗어나면 클라이언트가 서버에 "새로운 경로(Rerouting)"를 요청합니다.

### Q2. "ETA(예상 도착 시간)를 정확하게 계산하려면 어떤 데이터가 필요한가요?"
* **핵심 키워드**: `실시간 교통 정보`, `과거 이력(Historical Data)`, `기계 학습(ML)`
* **답변 논리**:
    * 단순 거리/속도 계산만으로는 부족합니다.
    * **실시간 교통량**(현재 속도), **도로 속성**(제한 속도, 신호등 수), **과거 패턴**(금요일 저녁 강남역) 등을 ML 모델에 입력하여 예측합니다.

### Q3. "지도 타일(이미지)을 CDN에 캐싱할 때, 갱신(Invalidation)은 어떻게 하나요?"
* **핵심 키워드**: `TTL`, `Versioning`, `능동적 갱신`
* **답변 논리**:
    * 지도 데이터는 자주 바뀌지 않으므로 긴 TTL을 둡니다.
    * 데이터가 변경되면(새로운 도로 개통 등), 해당 타일의 **버전 번호**를 올리거나(Versioning), CDN에 **Invalidation(무효화)** 요청을 보내 새 이미지를 받아가게 합니다.

---

## 3. 심화 토론 주제 (Deep Dive Discussion)
단순한 구현을 넘어 시스템의 확장성과 엣지 케이스를 고민해봅니다.

### 주제 A: 실시간 교통 상황 반영과 "적응형 ETA"
* **문제**: 내가 안내받은 경로 전방에서 갑자기 사고가 났다면?
* **해결책**:
    * **Quadtree/Geohash 기반 역색인**: "이 타일(도로)을 지나가는 사용자 목록"을 관리해야 합니다.
    * 사고 발생 시 해당 타일을 포함하는 경로를 가진 사용자들에게만 **푸시 알림**이나 **웹소켓**으로 경로 재탐색을 제안합니다. (책에서 언급한 "재귀적 타일 관리" 방식)

### 주제 B: 위치 정보 수집과 프라이버시 (익명화)
* **문제**: 사용자의 이동 경로를 그대로 저장하면 사생활 침해 우려가 있습니다.
* **해결책**:
    * **Start/End Trimming**: 집이나 회사 근처(출발/도착지)의 데이터는 잘라내고 저장합니다.
    * **ID Rotation**: 일정 시간마다 사용자 식별자(ID)를 변경하여 경로를 추적할 수 없게 만듭니다.

### 주제 C: 오프라인 모드 지원
* **상황**: 터널이나 산간 오지에서 네트워크가 끊긴다면?
* **접근법**:
    * 사용자가 경로 안내를 시작할 때, 경로 주변의 **지도 타일**과 **경로 데이터**를 미리 클라이언트에 다운로드(Prefetching) 해두어야 합니다.

---

## 4. 추가 학습 추천
* **A* (A-Star) 알고리즘**: 다익스트라(Dijkstra)보다 효율적인 경로 탐색 알고리즘. (휴리스틱 함수 사용)
* **OpenStreetMap (OSM)**: 전 세계 무료 지도 데이터 프로젝트. 실제 도로망 데이터를 다뤄보고 싶다면 추천.
* **Mapbox Vector Tiles**: 벡터 타일 표준을 만든 Mapbox의 기술 문서.
* **Quadtree & Hilbert Curve**: 공간 인덱싱 최적화 기법.
