## ⭐ 주변 사업장 검색 알고리즘

### 1. 2차원검색

- 주워진 반경으로 그린 원 안에 놓인 사업장을 검색.

```sql
/*2차원 검색 유사 SQL */
SELECT business_id, latitude, longitude
 FROM business
WHERE (latitude BETWEEN {:my_lat} - radius AND {:my_lat} + radius)
  AND (longitude BETWEEN {:my_long} - radius AND {:my_long} + radius)
```

- 장점: 단순함
- 단점: 테이블 전부를 여러 번 읽어야 하므로 비효율적 → 낮은 응답지연에 부적절

### ❗1차원 색인 사용

- 해시 기반: 균등격자, 지오해시, 카르테시안 계층
- 트리: 쿼드트리, 구글S2

### 2. 균등 격자

- 세계 지도를 위도와 경도로 균등하게 격자를 나누어 구획을 지정하는 방법
    - 장점: 단순함
    - 단점: 사업장 분표가 균등하지 않음. (태평양 한가운데에 사업장? 0개. 강남대로에 사업장 nnn개)

### 3. 지오해시(Geohash)

- 2차원의 위도 경도 데이터를 비트를 하나씩 늘려가면서 재귀적으로 세계지도를 더 작은 격자로 분할함
    - 위도 범위 [-90, 0]은 0에 대응
    - 위도 범위 [0, 90]은 1에 대응
    - 경도 범위 [-180, 0]은 0에 대응
    - 경도 범위 [0, 180]은 1에 대응
    
    | 01 | 11 |
    | --- | --- |
    | 00 | 10 |
    
    | 01 01 | 01 11 | 11 01 | 11 11 |
    | --- | --- | --- | --- |
    | 01 00 | 01 10 | 11 00 | 11 10 |
    | 00 01 | 00 11 | 10 01 | 10 11 |
    | 00 00  | 00 10 | 10 00 | 10 10 |
- 위 절차를 원하는 정밀도(precision)를 얻을 때 까지 반복. 통상적으로 base32 표현법을 사용해 표기
    - ex. 구글 본사 지오해시 (길이 =6)
        - 1001 11010 01001 10001 11111 11110 → 9q9hvu
- 사용자가 지정한 반경으로 그린 원을 덮는 최소 크기 격자를 만드는 지오해시 길이(정밀도)를 정해야함 → ❓ 각 지오해시 길이에 해당하는 지오해시인덱스 저장 필요
- 엣지케이스
    - **격자 가장자리 이슈1**: 두 지점이 적도의 다른 쪽에 놓이거나, 자오선상의 다른반대 쪽에 놓이는 경우(지구는 입체 구 형태) 공통 접두어가 일치하지 않음. (SELECT * FROM geohash_index WHERE geohash LIKE ‘9q8zn%’ 쿼리 사용 불가능)
    - **격자 가장자리 이슈2**: 두 지점이 공통 접두어 길이는 같지만 서로 다른 격자에 놓이는경우
        - 입접한 모든 격자의 모든 사업장 정보 가져오는 걸로 해결 가능
- 표시할 사업장이 충분하지 않은 경우
    - 선택지 1: 주어진 반경 내 사업장만 반환. → 사용자 욕구 충족 어려움
    - 선택지2: 검색반경을 키운다. → 확장 크기제한 필요. n개 이하면 최대 m회 확장.

### 4. 쿼드트리

- 격자의 내용이 특정 기준(EX. 격자 당 사업장 수가 100이하)을 만족할 때 까지 2차원 공간을 재귀적으로 사분면 분할. → 분할 된 맵의 형태가 균일하지 않음.
- 질의에 답하는데 사용 될 트리구조를 메모리 안에 생성해서 사용 = 각 LBS(위치기반서비스) 서버 시작 시점에 캐시에 구축

```java
/* 쿼드트리 구축 의사 코드 */
public void buildQuadtree(TreeNode node) {
	if (countNumberOfBusinessesInCurrentGrid(node) > 100) {
		node.subdivide();
		for (TreeNode child : node.getChildren()) {
			buildQuadtree(child);
		}
	}
}
```

- 메모리 요구량이 1.71GB, 쿼드트리 구축 소요 시잔 복잡도 n/100log(n/100)⇒ 200m의 사업장 인덱싱 쿼드트리구축시간: n분
- 쿼드트리 운영 시 고려사항.
    - 쿼드트리 구축 시 n분 간 트래픽 처리 불가능
        - 사용량이 적은 새벽에 캐시를 일괄 갱신하거나 각 서버를 점진적으로 갱신하는 방법으로 해결 가능

### 5. 구글 S2

- 메모리 기반
- 지구를 힐베르트 곡선이라는 공간 채움 곡선을 사용하여 1차원 색인화.
- ⭐지오펜스 구현에 적절
- 장점: 다양한 S2 도구를 제공
- 단점: 라이브러리 의존적

### 지오해시 vs 쿼드트리

| 지오해시 | 쿼드트리 |
| --- | --- |
| 구현, 사용 쉬움, 트리구축 불필요 | 트리구축 필요 |
| 색인 갱신 쉬움 O(1) | 색인 갱신 어려움 O(log n) |
| 격자크기 고정 | 격자크기 동적 조정 |
| 지정 반경 이내 사업장 검색 | k번째 근거리 사업장 검색 가능 |
