# 주변 친구

- 내 주변에 있는 사용자를 실시간으로 찾아주는 기능은 어떻게 설계될까요?

## 문제 정의 및 요구사항

대규모 시스템에서는 다음과 같은 제약 조건을 해결해야합니다.

- 핵심 기능: 사용자 위치 기반 반경 5km이내의 친구 목록 표시
- 실시간성: 친구가 이동하면 내 화면에서도 위치가 즉시 업데이트 되어야함
- 규모: 수백만 ~ 수억만의 사용자 지원

--- 

## 핵심 설계 (웹 소켓)

이 시스템의 생명은 실시간성입니다. 일반적인 http 요청 방식은 서버가 클라이언트에게 먼저 데이터를 보낼 수 없기 때문에 부적합니다.

### 웹 소켓 역할

- 양뱡향성: 클라이언트는 내 위치를 서버에 보내고, 서버는 친구의 위치를 나에게 즉시 보냅니다.
- 서버 푸시: 내가 요청하지 않아도 친구가 움직이면 서버가 즉시 알림을 통해 알려줄수 있습니다.
- 지속성: 한번 연결되면 계속 유지되므로, 매번 연결을 맺는 오버헤드가 없어 매우 빠릅니다.

--- 

## 핵심 엔진 (Redis Pub/Sub)

모든 사용자의 거리를 매번 DB에서 계산하는 것은 불가능합니다. 이 문제를 해결하는 치트키가 바로 Redis Pub/Sub입니다.

### 동작 우너리

- 채널 할당: 모든 사용자마다 고유한 전용 채널을 하나씩 가집니다.
- 구독: 내가 온라인이 되면, 내 친구들의 채널을 모두 구독합니다.
- 발행: 내가 움직이면 내 위치 정보를 나의 전용 채널에 올립니다.
- 전파: 내 채널을 구독하고 있던 친구들은 즉시 나의 새 위치를 수신하게 됩니다.
    - 핵심 포인트: 웹 소켓 서버는 중간 다리 역할을 합니다. 레디스에서 받은 메시지를 웹소켓 통로를 통해 실제 폰으로 전달하는 것이죠.

---

## 시스템 구성 요소

1. 웹소켓 서버: 클라이언트와 실시간 연결을 유지하며 메시지를 주고받는 관문.

2. 위치 서비스 (Location Service): 사용자의 최신 위치를 저장하고 이력을 관리하는 DB 서비스.

3. 사용자 상태 서버 (Presence Server): 누가 온라인인지 관리. (오프라인 친구에게는 위치 정보를 보낼 필요가 없어 자원을 아낍니다.)

4. Redis Pub/Sub: 수천만 개의 채널을 관리하며 위치 업데이트 이벤트를 실시간으로 중계.
    - A가 이동함 -> A의 위치 정보가 A의 레디스 채널로 전송
    - A의 친구들(B, C) -> 이미 A의 채널을 구독 중이므로, 즉시 A의 새 위치를 수신함
    - 레디스는 메모리 기반이라 매우 빠르기 때문에 수백만 건의 위치 업데이트를 처리하기 적합

--- 

## 심화

### 친구가 많은 유저가 움직일 때 시스템이 터지지 않을까?

상한선 설정: 최대 친구 수를 5천명 정도로 제한한다고 가정 (페이스북)

- 한명의 헤비 유저를 구독하는 수천명의 친구들은 하나의 서버가 아니 여러 웹소켓 서버에 흩어져 있습니다.  
  따라서 특정 웹소켓 서버에만 부하가 몰리는 핫스팟 문제는 발생하지 않습니다.

- 헤비 유저의 채널을 관리하는 특정 펍/섭 서버는 조금 더 부하를 받을 수 있지만, 수백대의 서버 클러스터에  
  이러한 헤비 유저들의 채널이 고르게 분산된다면 훙분히 감당 가능한 수준입니다.

## 성능을 끌어올리는 최적화 기술

1. 지오해시 활용
    - 지구 전체를 바둑판처럼 격자로 나누고 각 격자에 고유 번호를 붙이는 기술입니다.

2. 배터리 및 데이터 절약
    - 의미 없는 업데이트 방지: 사용자가 10m 이내로 움직였다면 서버에 보고하지 않습니다.
    - 거리 기반 차등 업데이트: 나랑 가까운 친구는 자주 업데이트하고, 4km쯤 떨어져 있는 친구는 조금 천천히 업데이트해도 사용자는 눈치채지 못합니다.
3. 레디스 Pub/Sub외 의 대안 (얼랭)
    - Redis 별도의 인프라 관리해야 하는 부담이 있지만, 얼랭은 언어와 플랫폼 자체가 대규모 분산 처리에 최적화되어 있습니다.
    - 경량 프로세스: 얼랭은 수백만 개의 프로세스를 아주 적은 메모리로 생성하고 관리할 수 있습니다.
    - 분산 메시지 패싱: 별도의 Redis 없이도 클러스터 내의 서버들이 서로 직접 메시지를 주고 받을 수 있다.
    - 고가용성: 시스템 가동 중에도 코드를 교체할 수 있고, 특정 프로세스가 죽어도 다른 프로세스에 영향을 주지 않는 격리 구조

--- 

## 요약 및 결론

주변 친구 서비스 설꼐의 핵심은 웹소켓으로 실시간 통로를 만들고, 레디스 pub/sub으로 효율적인 메시지 전파를 구현하는 것입니다.
여기에 지오해시를 통해 지역 필터링과 클라이언트 단의 전송 조절이 더해지면 수억 명의 사용자도 감당할 수 있는 시스템을 완성합니다.
